<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Business Global Verification</title>

  <!-- CSP for GitHub Pages (adjust as needed) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://www.googleapis.com https://firestore.googleapis.com; script-src 'self' https://www.gstatic.com https://www.googleapis.com https://firestore.googleapis.com 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <style>
    /* Basic styling... */
  </style>
</head>
<body>
  <div class="container">
    <h1>Business Verification</h1>
    <form id="verificationForm">
      <!-- Your fields... -->
      <label for="businessName">Business Name</label>
      <input type="text" id="businessName" required />

      <label for="country">Country</label>
      <select id="country" required>
        <option value="">Select your country</option>
        <option value="USA">USA</option>
        <!-- ... -->
      </select>

      <label for="businessRegDoc">Business Registration Document</label>
      <input type="file" id="businessRegDoc" required />

      <label for="taxId">Tax ID / EIN / VAT Number</label>
      <input type="text" id="taxId" required />

      <button type="submit" id="submitButton">Submit Verification</button>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // 1) Initialize Firebase
    const firebaseConfig = {
      // your config
      apiKey: "xxx",
      authDomain: "xxx.firebaseapp.com",
      projectId: "xxx",
      storageBucket: "xxx.appspot.com",
      messagingSenderId: "xxx",
      appId: "xxx"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 2) SIGN IN using email & password from React Native (injected)
    //    (In production, you would use a Custom Token approach)
    const userEmail = window.USER_EMAIL || "";
    const userPassword = window.USER_PASSWORD || "";
    if (userEmail && userPassword) {
      auth.signInWithEmailAndPassword(userEmail, userPassword)
        .then(credential => {
          console.log("✅ WebView signed in as:", credential.user.uid);
        })
        .catch(err => {
          console.error("❌ Sign-in error:", err);
        });
    } else {
      console.warn("No user credentials provided. The user may not be authenticated in WebView.");
    }

    // 3) File Upload Helper
    async function uploadFile(file) {
      if (!file) return "";

      const currentUser = auth.currentUser;
      if (!currentUser) {
        throw new Error("No authenticated user in WebView.");
      }
      const userId = currentUser.uid;

      const timestamp = Date.now();
      const storageRef = storage.ref(`verifications/${userId}/${timestamp}_${file.name}`);
      const uploadTask = storageRef.put(file);

      return new Promise((resolve, reject) => {
        uploadTask.on("state_changed",
          // progress callback
          snapshot => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log(`Upload is ${progress}% done`);
          },
          // error callback
          error => {
            console.error("❌ Upload error:", error);
            reject(error);
          },
          // success callback
          async () => {
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
            console.log("✅ File uploaded. URL:", downloadURL);
            resolve(downloadURL);
          }
        );
      });
    }

    // 4) Handle Form Submission
    document.getElementById('verificationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const businessName = document.getElementById('businessName').value.trim();
      const country = document.getElementById('country').value.trim();
      const taxId = document.getElementById('taxId').value.trim();
      const file = document.getElementById('businessRegDoc').files[0];

      if (!businessName || !country || !taxId || !file) {
        alert("Please fill all required fields.");
        return;
      }

      try {
        const fileURL = await uploadFile(file);

        // Save to Firestore
        await db.collection('business_verifications').add({
          uid: auth.currentUser?.uid || null,
          businessName,
          country,
          taxId,
          fileURL,
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Let the user know it's done
        alert("✅ Verification submitted successfully!");

        // Send message back to React Native
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ event: "formSubmitted" }));
        }

        // Reset the form
        document.getElementById('verificationForm').reset();
      } catch (error) {
        console.error("❌ Submission error:", error);
        alert("Submission failed: " + error.message);
      }
    });
  </script>
</body>
</html>
